@using Svbase.Core.Enums
@using Svbase.Core.Models
@model DistrictViewInitDataModel

<div class="body-content">
    <div class="row">
        <div class="container">
            <div id="district-alert-success" class="row" style="position: relative">
                <div class="alert alert-success district-alert display-none" style="font-weight: bold">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    Збережено.
                </div>
            </div>
            <div id="district-alert-danger" class="row" style="position: relative">
                <div class="alert alert-danger district-alert display-none" style="font-weight: bold">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    Виберіть округ і будинки.
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <h3 class="page-header">Управління округами</h3>
                </div>
            </div>

            <div class="row padding-bottom-15">
                <div class="col-md-12 ignore-padding">
                    <div class="col-md-6">
                        <div class="btn-group btn-group-toggle" data-toggle="buttons">
                            <label class="btn btn-secondary  active"
                                   onclick="getDistrictsBy(@((int) DistrictType.Сonstituency))">
                                <input type="radio"
                                       name="options"
                                       id="constituency-districts"
                                       autocomplete="off"
                                       checked> Партійний
                            </label>
                            <label class="btn btn-secondary"
                                   onclick="getDistrictsBy(@((int) DistrictType.Custom))">
                                <input type="radio"
                                       name="options"
                                       id="custom-districts"
                                       autocomplete="off"> Виборчий
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-primary pull-right" onclick="saveDistrict()">
                            <a class="white-color">Зберегти</a>
                        </button>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="col-sm-3 padding-item">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="panel panel-default">
                                    <div class="panel-heading" style="font-weight: bold">
                                        Округи
                                        <i class="fa fa-plus-square fa-lg cursor-pointer"
                                           onclick="openCreateDistrictModal()"
                                           id="add-district-icon"
                                           style="color: #428bca; text-align: right; float: right"></i>
                                    </div>
                                    <div class="panel-body" id="districts-panel-body">
                                        @Html.Partial("_DistrictsPanelBody", @Model.Districts)
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-3 padding-item">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="panel panel-default">
                                    <div class="panel-heading" style="font-weight: bold">
                                        Населений пункт
                                        @*<i class="fa fa-plus-square fa-lg" style="color: #428bca; text-align: right; float: right"
                                            data-toggle="modal"
                                            data-target="#cityCreateModal"></i>*@
                                    </div>
                                    <div class="panel-body" id="cities-panel-body">
                                        @Html.Partial("_DistrictsPanelBody", @Model.Cities)
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-3 padding-item">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="panel panel-default">
                                    <div class="panel-heading" style="font-weight: bold">
                                        Вулиця
                                        @*<i class="fa fa-plus-square fa-lg" style="color: #428bca; text-align: right; float: right"
                                            data-toggle="modal"
                                            data-target="#streetCreateModal"></i>*@
                                    </div>
                                    <div class="scrollbar">
                                        <div class="panel-body" id="streets-panel-body">
                                            @Html.Partial("_DistrictsPanelBody", new List<DistrictPanelBodyItemModel>())
                                        </div>
                                    </div>
                                 </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-3 padding-item">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="panel panel-default">
                                    <div class="panel-heading" style="font-weight: bold">
                                        <div class="row">
                                            <div class="col-xs-12">
                                                <span class="pull-left">№ Буд</span>
                                                <input onclick="checkAllApartments()" class="pull-right" type="checkbox" id="all-apartments"/>
                                                <label class="pull-right cursor-pointer margin-right-xs" 
                                                       style="font-weight: normal"
                                                       for="all-apartments">Вибрати всі</label>
                                            </div>
                                        </div>
                                        @*<i class="fa fa-plus-square fa-lg" style="color: #428bca; text-align: right; float: right"
                                            data-toggle="modal"
                                            data-target="#apartmentCreateModal"></i>*@
                                    </div>
                                    <div class="scrollbar">
                                        <div class="panel-body" id="apartments-panel-body">
                                            @Html.Partial("_DistrictApartmentPanelBody", new List<DistrictPanelBodyApartmentModel>())
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@*@Html.Partial("_BeneficiaryCreate", new BeneficiaryCreateModel())*@
@Html.Partial("_DistrictCreate", new DistrictListModel())
@*@Html.Partial("_CityCreate", new CityCreateModel())
    @Html.Partial("_ApartmentCreate", new ApartmentCreateModel())
    @Html.Partial("_FlatCreate", new FlatCreateModel())

    @Html.Partial("_StreetEdit")
    @Html.Partial("_ConfirmDelete")*@
<script>



    $(document).ready(() => {
        window.isDirty = false;
    });

    function getDistrictsBy(districtType) {
        var data = {
            DistrictType: districtType
        };
        $.get('@Url.Action("DistrictsBy","District")', data)
            .done((result) => {
                $("#districts-panel-body").html(result);
            });
    }

    function openCreateDistrictModal() {
        $('#districtCreateModal').modal('show');
    }

    function saveDistrict() {
        var activeDistrict = $("#districts-panel-body > .row.factor-item-active");
        var activeDistrictId = Number(activeDistrict.attr("data-item"));
        var activeStreet = $("#streets-panel-body > .row.factor-item-active");
        var activeStreetId = Number(activeStreet.attr("data-item"));
        var apartmentIds = getCheckedApartmentIds();
        var urlAction = "@Url.Action("SaveDistrict")";
        var model = {
            districtId: activeDistrictId,
            streetId: activeStreetId,
            apartmentIds: apartmentIds
        };

        $.ajax({
            url: urlAction,
            type: 'Post',
            data: { model: model },
            async: false
        }).done((data) => {
            showDistrictAlertSuccess();
            window.isDirty = false;
            $("#apartments-panel-body").html(null);
            var streetRows = $("#streets-panel-body > .row");
            streetRows.removeClass("factor-item-active");
        }).fail((resp) => {
            showDistrictAlertDanger();
        });
    }

    function showDistrictAlertSuccess() {
        if ($("#district-alert-success > div").hasClass("display-none")) {
            $("#district-alert-success > div").removeClass("display-none");
        }
        $("#district-alert-success").fadeIn("slow");
        window.setTimeout(function () {
            $("#district-alert-success").fadeOut("slow");
        }, 3000);
    }

    function showDistrictAlertDanger() {
        if ($("#district-alert-danger > div").hasClass("display-none")) {
            $("#district-alert-danger > div").removeClass("display-none");
        }

        $("#district-alert-danger").fadeIn("slow");
        window.setTimeout(function () {
            $("#district-alert-danger").fadeOut("slow");
        }, 3000);
    }

    function getCheckedApartmentIds() {
        var apartmentIds = [];
        $(".row.factor-item input:checked").each((index, element) => {
            if (!isNaN($(element).val())) {
                var id = Number($(element).val());
                apartmentIds.push(id);
            }
        });
        return apartmentIds;
    }


    function checkAllApartments() {
        var allApartments = $("#all-apartments");
        var isChecked = $(allApartments).prop("checked");
        var targets = $("#apartments-panel-body input");
        if (!targets || targets.length === 0) return;

        window.isDirty = true;
        if (!isChecked) {
            $(targets).prop("checked", false);
        } else {
            $(targets).prop("checked", true);
        }
    }

</script>